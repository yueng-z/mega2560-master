#include "dino.h"
#include "dino_ShareData.h"
#include "dino_Sharemethod.h"
#include "stdlib.h"
#include "board.h"
#include "oled.h"
#include "key.h"
#include "dino_Castle.h"
#include "dino_menu.h"


//OLED的显存
//存放格式如下.
//[0]0 1 2 3 ... 127
//[1]0 1 2 3 ... 127
//[2]0 1 2 3 ... 127
//[3]0 1 2 3 ... 127
//[4]0 1 2 3 ... 127
//[5]0 1 2 3 ... 127
//[6]0 1 2 3 ... 127
//[7]0 1 2 3 ... 127


const signed char   xspeed_arr[] = {0,1,1,2,2,3,5};
const char          xspeed_last = 6;
const signed char   yspeed_arr[] = {1, 1, 3, 3, 4, 4, 5, 6, 7};
char 				dino_in_pit = 0;
char 				*P_dino_in_pit = &dino_in_pit;

signed char edge_dinox[]={1,1,1,1};
signed char	edge_dinoy[]={1,1,1,1};


const unsigned char  rightDINO[2][32] =
{
    0xe0, 0x80, 0x0, 0x0, 0x0, 0x80, 0xc0, 0xe0, 0xfe, 0xff, 0xfd, 0xbf, 0xaf, 0x2f, 0x2f, 0xe, 0x3, 0x7, 0xf, 0x1e, 0xff, 0xbf, 0x1f, 0x1f, 0x3f, 0x2f, 0x7, 0x0, 0x1, 0x0, 0x0, 0x0,
    0xe0, 0x80, 0x0, 0x0, 0x0, 0x80, 0xc0, 0xe0, 0xfe, 0xff, 0xfd, 0xbf, 0xaf, 0x2f, 0x2f, 0xe, 0x3, 0x7, 0xf, 0x1e, 0x3f, 0x7f, 0x5f, 0x3f, 0xff, 0x8f, 0x7, 0x0, 0x1, 0x0, 0x0, 0x0
};

const unsigned char  leftDINO[2][32] =
{
	0xe,0x2f,0x2f,0xaf,0xbf,0xfd,0xff,0xfe,0xe0,0xc0,0x80,0x0,0x0,0x0,0x80,0xe0,0x0,0x0,0x0,0x1,0x0,0x7,0x2f,0x3f,0x1f,0x1f,0xbf,0xff,0x1e,0xf,0x7,0x3,
	0xe,0x2f,0x2f,0xaf,0xbf,0xfd,0xff,0xfe,0xe0,0xc0,0x80,0x0,0x0,0x0,0x80,0xe0,0x0,0x0,0x0,0x1,0x0,0x7,0x8f,0xff,0x3f,0x5f,0x7f,0x3f,0x1e,0xf,0x7,0x3,
};

const unsigned char  right_DINO_JUMP[8][48] =  //	
{
	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0x80, 0x0, 0x0, 0x0, 0x80, 0xc0, 0xc0, 0xfe, 0xff, 0xfd, 0xbf, 0xaf, 0x2f, 0x2f, 0xe, 0x3, 0x7, 0xf, 0x1f, 0xff, 0xbf, 0x1f, 0x3f, 0xff, 0x8f, 0x7, 0x0, 0x1, 0x0, 0x0, 0x0,

	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x0, 0xf0, 0xc0, 0x80, 0x80, 0x80, 0xc0, 0xe0, 0xe0, 0xff, 0xff, 0xfe, 0x5f, 0xd7, 0x17, 0x17, 0x7, 0x1, 0x3, 0x7, 0xf, 0x7f, 0x5f, 0xf, 0x1f, 0x7f, 0x47, 0x3, 0x0, 0x0, 0x0, 0x0, 0x0,

	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xc0, 0x40, 0xc0, 0xc0, 0xc0, 0xc0, 0x80, 0xf8, 0xe0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0, 0xf0, 0xff, 0xff, 0xff, 0x2f, 0x6b, 0xb, 0xb, 0x3, 0x0, 0x1, 0x3, 0x7, 0x3f, 0x2f, 0x7, 0xf, 0x3f, 0x23, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0,

	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0xe0, 0xa0, 0xe0, 0xe0, 0xe0, 0xe0, 0xc0, 0x7c, 0xf0, 0xe0, 0xe0, 0xe0, 0xf0, 0xf8, 0xf8, 0xff, 0xff, 0xff, 0x17, 0x35, 0x5, 0x5, 0x1, 0x0, 0x0, 0x1, 0x3, 0x1f, 0x17, 0x3, 0x7, 0x1f, 0x11, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,

	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe0, 0xf0, 0xd0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x3e, 0x78, 0xf0, 0xf0, 0xf0, 0xf8, 0xfc, 0xfc, 0xff, 0xff, 0x7f, 0xb, 0x1a, 0x2, 0x2, 0x0, 0x0, 0x0, 0x0, 0x1, 0xf, 0xb, 0x1, 0x3, 0xf, 0x8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,

	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf0, 0xf8, 0xe8, 0xf8, 0x78, 0x78, 0x78, 0x70, 0x1f, 0x3c, 0x78, 0xf8, 0xf8, 0xfc, 0xfe, 0xfe, 0xff, 0x7f, 0x3f, 0x5, 0xd, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7,
	0x5, 0x0, 0x1, 0x7, 0x4, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,

	0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf8, 0xfc, 0xf4, 0xfc, 0xbc, 0xbc, 0xbc, 0x38, 0xf, 0x1e, 0x3c, 0x7c, 0xfc, 0xfe, 0x7f, 0xff, 0xff, 0x3f, 0x1f, 0x2, 0x6, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3,
	0x2, 0x0, 0x0, 0x3, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,

	0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0xfc, 0xfe, 0xfa, 0x7e, 0x5e, 0x5e, 0x5e, 0x1c, 0x7, 0xf, 0x1e, 0x3e, 0xfe, 0x7f, 0x3f, 0x7f, 0xff, 0x1f, 0xf, 0x1, 0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1,
	0x1, 0x0, 0x0, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
};


const char left_DINO_JUMP[8][48] =  //	left
{
	0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xe, 0x2f, 0x2f, 0xaf, 0xbf, 0xfd, 0xff, 0xfe, 0xc0, 0xc0, 0x80, 0x0, 0x0, 0x0, 0x80, 0xe0, 0x0, 0x0, 0x0, 0x1, 0x0, 0x7, 0x8f, 0xff, 0x3f, 0x1f, 0xbf, 0xff, 0x1f, 0xf, 0x7, 0x3, 
	0x0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x17, 0x17, 0xd7, 0x5f, 0xfe, 0xff, 0xff, 0xe0, 0xe0, 0xc0, 0x80, 0x80, 0x80, 0xc0, 0xf0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0x47, 0x7f, 0x1f, 0xf, 0x5f, 0x7f, 0xf, 0x7, 0x3, 0x1, 
	0x80, 0xc0, 0xc0, 0xc0, 0xc0, 0x40, 0xc0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0xb, 0xb, 0x6b, 0x2f, 0xff, 0xff, 0xff, 0xf0, 0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x23, 0x3f, 0xf, 0x7, 0x2f, 0x3f, 0x7, 0x3, 0x1, 0x0, 
	0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xa0, 0xe0, 0xc0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x5, 0x5, 0x35, 0x17, 0xff, 0xff, 0xff, 0xf8, 0xf8, 0xf0, 0xe0, 0xe0, 0xe0, 0xf0, 0x7c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x11, 0x1f, 0x7, 0x3, 0x17, 0x1f, 0x3, 0x1, 0x0, 0x0, 
	0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xd0, 0xf0, 0xe0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x2, 0x1a, 0xb, 0x7f, 0xff, 0xff, 0xfc, 0xfc, 0xf8, 0xf0, 0xf0, 0xf0, 0x78, 0x3e, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8, 0xf, 0x3, 0x1, 0xb, 0xf, 0x1, 0x0, 0x0, 0x0, 
	0x70, 0x78, 0x78, 0x78, 0xf8, 0xe8, 0xf8, 0xf0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0xd, 0x5, 0x3f, 0x7f, 0xff, 0xfe, 0xfe, 0xfc, 0xf8, 0xf8, 0x78, 0x3c, 0x1f, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4, 0x7, 0x1, 0x0, 0x5, 0x7, 0x0, 0x0, 0x0, 0x0, 
	0x38, 0xbc, 0xbc, 0xbc, 0xfc, 0xf4, 0xfc, 0xf8, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0x0, 0x0, 0x0, 0x6, 0x2, 0x1f, 0x3f, 0xff, 0xff, 0x7f, 0xfe, 0xfc, 0x7c, 0x3c, 0x1e, 0xf, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x3, 0x0, 0x0, 0x2, 0x3, 0x0, 0x0, 0x0, 0x0, 
	0x1c, 0x5e, 0x5e, 0x5e, 0x7e, 0xfa, 0xfe, 0xfc, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc0, 0x0, 0x0, 0x0, 0x3, 0x1, 0xf, 0x1f, 0xff, 0x7f, 0x3f, 0x7f, 0xfe, 0x3e, 0x1e, 0xf, 0x7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1, 0x0, 0x0, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 
};

const unsigned char  RESTART[] ={
	0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x3f, 0x3f, 0x3f, 0xf, 0x1f, 0x3f, 0xff, 0xff, 0xff, 0x3f, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
	0xff, 0xff, 0xff, 0xff, 0xff, 0x0, 0x0, 0x7e, 0x7e, 0x7e, 0x78, 0x7c, 0x7e, 0x7f, 0x7f, 0x7f, 0x7e, 0x0, 0x0, 0xff, 0xff, 0xff, 0xff, 0xff,
	0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f,
};


//小恐龙控制接入
void OLED_dino_control(char keyValue)
{
	static char last_foothold = 1;
	static short last_2times_dino_y = 0;
	//水平
	//水平控制
	if (left)//左
	{
        if (x_sta > -xspeed_last)
		{
			x_sta--;
		}
	}
	if(right)//右
	{
		if (x_sta < xspeed_last)
		{
			x_sta++;
		}
	}
	if(keyValue == No_key)
	{
		if (x_sta > 0)
		{
			x_sta--;
		}
		else if (x_sta < 0)
		{
			x_sta++;
		}
	}
	if(Esc)//右
	{
		Draw_pausemenu();
	}
	//水平速度
	if (x_sta < 0)
	{
		
		dino_xspeed = -xspeed_arr[-x_sta];
	}
	else
	{
		dino_xspeed = xspeed_arr[x_sta];
	}

	//垂直
	//垂直控制
	if (!foothold)
	{	
		if (!jumping)
		{
			dino_yspeed = -yspeed_arr[y_sta];
			if (y_sta < 8)
			{
				y_sta++;
			}
		}
        else if(0x01&keyValue)
        {
			if (control == 0)
			{
				jumping = 0;
				y_sta = 0;
				dino_yspeed = yspeed_arr[y_sta];
			}
        }
	}
	else if(up)
	{
        UART1_send(mla_jump,6);
		jumping = 1;
        //jump_start_y = dino_y;
        y_sta = sizeof(yspeed_arr) - 1;
	}
	else
	{
			dino_yspeed = 0;
			y_sta = 0;
	}

    if (jumping)
    {
		dino_yspeed = yspeed_arr[y_sta];
		if(y_sta > 0) y_sta--;
    }

	if (foothold != last_foothold)
	{
		jump_start_y = last_2times_dino_y;
	}
	last_foothold = foothold;
	last_2times_dino_y = dino_y;
	//清噪点
	if (keyValue == K1_4)
	{
		oledClear();
	}

}

//小恐龙位置解算
void OLED_dino_pos()
{
	static int tail = 3000;
	signed char x;
	
    if(dino_xspeed < 0)
    {
        direction = '<-';
    }
    else if (dino_xspeed > 0)
    {
        direction = '->';
    }
    

	dino_x += dino_xspeed;
	if (pos_on_map <= begin_pos_on_map && dino_x < 56)
    {
        dino_pos_state = 1;

        if (dino_x < 0)
        {
            dino_x = 0;
            dino_xspeed = 0;
            x_sta = 0; 
        }
    }
	else if(pos_on_map >= tail && dino_x > 56)
    {
        dino_pos_state = 3;

        if (dino_x > 127 - 16)
        {
            dino_x = 127 - 16;
            dino_xspeed = 0;
            x_sta = 0;
        }
    }
	else
	{
        dino_pos_state = 2;
		x = dino_x - 56;
		dino_x = 56;
		pos_on_map += x;

		if (pos_on_map < begin_pos_on_map)
		{
			x = pos_on_map - begin_pos_on_map;
			dino_x += x;
			pos_on_map = begin_pos_on_map;
		}
		else if (pos_on_map > tail)
		{
			x = pos_on_map - tail;
			dino_x += x;
			pos_on_map = tail;
		}
		
	}
    // printf("dino_x  = %d ,pos_on_map = %d ||",dino_x,pos_on_map);
    dino_y += dino_yspeed;
}

// 绘制小恐龙
void OLED_DrawDino()
{
    static char state;
	static unsigned char dino_dir = 0;
	unsigned int j=0;
	unsigned char x, y;
	unsigned char byte;
	
	static int last_screen_x;
	static int last_screen_y;
	static signed char last_deep;
	int* p1 = &last_screen_x;
	int* p2 = &last_screen_y;
	signed char* p3 = &last_deep;

	last_dino_y = dino_y;
    dino_deep = (6 - dino_y/8);
	cover = 1;
    if (dino_xspeed != 0)
    {
        dino_dir++;
    }
	dino_dir = dino_dir%2;
	for(y=0; y<2; y++)
	{
        if (dino_deep + y < 0) continue;
		OLED_SetPos(dino_x, dino_deep+y);
		for (x = 0; x < 16; x++)
		{
			j = y*16 + x;
			if (direction == '->')
			{
				if(castle_sign)
				{
					if (screen_left + dino_x + x >= castle_pos[0] + 24 && screen_left + dino_x +15 <= castle_pos[0] + 39) 
					{
						cover = 0;
						break;
					}
				}
				byte = rightDINO[dino_dir][j];
			}
			else if (direction == '<-')
			{
				if (castle_sign)
				{
					if (screen_left + dino_x  >= castle_pos[0] + 24 && screen_left + dino_x + x <= castle_pos[0] + 39) 
					{	
						cover = 0;
						continue;
					}
				}
				byte = leftDINO[dino_dir][j];
			}
			oledWriteByte(byte,OLED_DATA);
		}
	}
	OLED_shadowclear(dino_x, dino_y, dino_deep, 16, 16, p1, p2, p3, hentai);
	// edge_dinox[0]=dino_x;
    // edge_dinox[1]=dino_x+8;
    // edge_dinox[2]=dino_x+8;
    // edge_dinox[3]=dino_x;
    // edge_dinoy[0]=dino_deep+1;
    // edge_dinoy[1]=dino_deep+1;
    // edge_dinoy[2]=dino_deep-1;
    // edge_dinoy[3]=dino_deep-1;
}

//我的绘制跳跃小恐龙
int OLED_DrawDinoJump()
{
    unsigned int j=0;
	unsigned char x, y;
    static signed int height = 0;
    signed char offset = 0;//小恐龙脚部所在行
	unsigned char byte;
    
	static int last_screen_x;
	static int last_screen_y;
	static signed char last_deep;
	int* p1 = &last_screen_x;
	int* p2 = &last_screen_y;
	signed char* p3 = &last_deep;

	last_dino_y = dino_y;
	height = dino_y - jump_start_y;
	//printf("jump_start_y =%d",jump_start_y);
	
	cover = 1;
    if(height >= 31)
	{
		jumping = 0;
		dino_y = jump_start_y + 31;
        height = 31;
		y_sta = 0;
	}
	if(height < 0)
	{
		height = 7+(height + 1)%8;
	}
    if(foothold)
	{
        y_sta = 0;
		dino_yspeed = 0;
	}
    //printf("height=%d,dino_y=%d,jump_start_y=%d, -1%8 = %d  ",height,dino_y,jump_start_y,-1%8);
	if(dino_y < -16) offset = -3;
	else if(dino_y < -8) offset = -2;
	else if(dino_y < 0) offset = -1;
	else if(dino_y <= 7) offset = 0;
	else if(dino_y <= 15) offset = 1;
	else if(dino_y <= 23) offset = 2;
	else if(dino_y <= 31) offset = 3;
	else if(dino_y <= 39) offset = 4;
    else if(dino_y <= 47) offset = 5;
	else if(dino_y <= 55) offset = 6;
	else if(dino_y <= 63) offset = 7;
	else return 0;
	//printf("dino_y = %d ,jump_start_y = %d, height = %d  ",dino_y,jump_start_y, height);
	for(y=0; y<3; y++) // 4
	{
        if (5 - offset + y < 0) continue;
		if(5- offset + y > 7) break;
		OLED_SetPos(dino_x, 5- offset + y);
		for (x = 0; x < 16; x++) // 32
		{
			if(5- offset + y < 0)
			{
				continue;
			}
			j = y*16 + x; // 32
			if (direction == '->')
			{
				byte = right_DINO_JUMP[height%8][j];
			}
			else if (direction == '<-')
			{
				byte = left_DINO_JUMP[height%8][j];
			}
			oledWriteByte(byte,OLED_DATA);
		}
	}
    dino_deep = 6 - offset;
	OLED_shadowclear(dino_x, dino_y, dino_deep, 16, 16, p1, p2, p3, hentai);
	// edge_dinox[0]=dino_x;
    // edge_dinox[1]=dino_x+8;
    // edge_dinox[2]=dino_x+8;
    // edge_dinox[3]=dino_x;
    // edge_dinoy[0]=dino_deep+1;
    // edge_dinoy[1]=dino_deep+1;
    // edge_dinoy[2]=dino_deep-1;
    // edge_dinoy[3]=dino_deep-1;
}


int shit()
{
    unsigned int j=0;
        unsigned char x, y;
        static unsigned char dino_x = 0;
        static unsigned char height = 0;
        unsigned char byte;
        for(y=0; y<3; y++) // 4
        {
            OLED_SetPos(dino_x, 5 + y);
            for (x = 0; x < 16; x++) // 32
            {
                j = y*16 + x; // 32
                byte = right_DINO_JUMP[height%8][j];
                oledWriteByte(byte,OLED_DATA);
            }
        }
        dino_x +=16;
        height++;
return 1;
}

//绘制重启
void OLED_DrawRestart()
{
	unsigned int j=0;
	unsigned char x, y;
	unsigned char byte;
	//OLED_SetPos(0, 0);
	for (y = 2; y < 5; y++)
	{
		OLED_SetPos(52, y);
		for (x = 0; x < 24; x++)
		{
			byte = RESTART[j++];
			oledWriteByte(byte,OLED_DATA);
		}
	}
	/*
	oledShowString(10, 3, "GAME", 16);
	oledShowString(86, 3, "OVER", 16);
	*/
}




