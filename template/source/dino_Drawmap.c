#include "dino_Drawmap.h"
#include "dino_ShareData.h"
#include "oled.h"
#include "dino_Pit.h"
#include "dino_Flag.h"
#include "dino_Castle.h"
#include "dino_Square.h"
#include "dino_Goldcoin.h"
#include "dino_Chicken.h"
// #include "dino_Chicken.h"

const unsigned char  GROUND[] ={
0xc8, 0xc8, 0xc8, 0x28, 0x28, 0x28, 0x8, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x8, 0x8, 0xc8, 0xc8, 0xc8, 0x8, 0x38, 0x38, 0x8,
0x8, 0x8, 0x8, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x8, 0x48, 0x48, 0x48, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0xc8, 0x8,
0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x38, 0x38, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x8, 0x28, 0x28, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x8, 0x8, 0x8, 0x8, 0x38, 0x38, 0x8, 0x68, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x8, 0x8, 0x8, 0x8,
0x8, 0x8, 0x8, 0x48, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0xc8, 0xc8, 0x8, 0x9, 0x8, 0x8, 0x8, 0x8, 0x8, 0x38, 0x38, 0x8, 0x8, 0x28, 0x8, 0x9, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x9, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x68, 0x8, 0xc9, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x29, 0x8, 0x8, 0x8, 0x8,
0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x49, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x68, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x68, 0x8, 0x8, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x28, 0x8, 0x8, 0x48, 0x8, 0x38,
0x38, 0x8, 0x8, 0x8, 0x8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x8, 0xc8, 0xc8, 0xc8, 0x28, 0x28, 0x28, 0x8, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x48, 0x8, 0x8, 0xc8, 0xc8, 0xc8, 0x8, 0x38, 0x38, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x48, 0x48, 0x48, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0xc8, 0x8, 0x8, 0x8, 0xc, 0x6, 0x2, 0x42, 0x42, 0x6, 0xc, 0x8, 0x8, 0x8, 0x8, 0x38, 0x38, 0x8, 0x18, 0x18, 0x10, 0x10, 0x10, 0x10, 0x10, 0x18, 0x18, 0x8, 0x48, 0x8, 0x28, 0x28, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x38, 0x38, 0x68, 0x68, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x48, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x68, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0xc8, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x38, 0x38, 0x8, 0x8, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x68, 0x8, 0xc8, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0xc, 0x4, 0x6, 0x2, 0x2, 0x6, 0xc, 0x4c, 0x48, 0x8, 0x8, 0x8, 0xc, 0x4, 0x6, 0x2, 0x2, 0x6, 0xc, 0xc, 0x68, 0x68, 0x8, 0x28, 0x28, 0x28, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x68, 0x68, 0x68, 0x8, 0x8, 0xc8, 0xc8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8, 0x28, 0x28, 0x28, 0x28, 0x8, 0x8, 0x8,
0x8, 0x8, 0x28, 0x28, 0x28, 0x8, 0x8, 0x48, 0x28, 0x38, 0x38, 0x8, 0x8, 0x8, 0x8, 0xc8, 0x8, 0x8,
};

const unsigned char  CLOUD[] =
{
	0x80, 0xc0, 0xe0, 0x70, 0xb0, 0xb0, 0xb0, 0x98, 0x88, 0x8e, 0x83, 0x83, 0x83, 0x81, 0x81, 0x93, 0x8e, 0x8c, 0x88, 0x88, 0x98, 0xb0, 0xf0, 0xc0
};

unsigned int        ground_length = sizeof(GROUND);
unsigned short      x;
extern char 		dino_in_pit;


void OLED_Drawmap()
{
    OLED_DrawFlag();
    OLED_DrawGround();
	OLED_DrawSquare();
    OLED_DrawCloud();
	Chicken();
	COIN();
	OLED_ShowScore();
}

//绘制地板
void OLED_DrawGround()
{


	short Draw_length = 0;
	short *p_Draw_length = &Draw_length;
	char flag_sign;
	char ground_sign;
	char drawmode = 0;
	char *p_drawmode = &drawmode;

	load_pit();
	flag_sign = load_flag();
	castle_sign = load_castle();
	if (castle_sign)
	{
		OLED_Drawcastle(castle_sign);
	}
	
	//printf("screen_pit[2][0] = %d ,screen_pit[2][1] = %d ",screen_pit[2][0],screen_pit[2][1]);
	OLED_SetPos(0, 7);
	for (x = 0; x < 128; x++)
	{
		ground_sign = 1;

        if ((x == dino_x) && (dino_y < 8))
        {
            x+=15;//continue后x会加一
			Draw_length -= 16;
            OLED_SetPos(x + 1, 7);
            continue;
        }

		//oledWriteByte(GROUND[(x+pos_on_map)%ground_length],OLED_DATA);
        //printf("ground_length = %d,(x+pos_on_map)%128 = %d,dino_x = %d,",ground_length,(x+pos_on_map)%128,dino_x);
		//printf("x= %d, drawmode = %d,  ",x,drawmode);
		if(!(Draw_length > 0))
		{
			drawmode = Can_I_Draw_Pit(x,p_Draw_length);
		}
		
		if(Draw_length > 0)
		{
			if (drawmode)
			{
				OLED_DrawPit(p_drawmode,Draw_length,x);
				ground_sign = 0;
				if (!(Draw_length > 0))
				{
					drawmode = 0;
				}
			}
		}
		Draw_length--;
		
		//printf("ground_sign= %d",ground_sign);
		if (flag_sign == 1)
		{
			if (x + screen_left >= flag_pos[0] - 3 && x + screen_left <= flag_pos[0] + 15)
			{
				ground_sign = 0;
				if (x + screen_left == flag_pos[0] + 15)
				{
					OLED_SetPos(x + 1, 7);
				}
				
			}
			
		}
		if (castle_sign)
		{
			if (x + screen_left >= castle_pos[0] && x + screen_left <= castle_pos[0] + 63)
			{
				ground_sign = 0;
				if (x + screen_left == castle_pos[0] + 63)
				{
					OLED_SetPos(x + 1, 7);
				}
			}
		}
		

		if(ground_sign == 1) 
		{
			oledWriteByte(GROUND[(x + screen_left)%ground_length],OLED_DATA);
		}
	}
	// printf("dino_y = %d dino_in_pit = %d  ||",dino_y,dino_in_pit);
	//printf("screen_pit[0][0] = %d ,dino_x = %d, dino_right = %d,screen_pit[0][0]_right = %d ",screen_pit[0][0],dino_x,dino_x+15,screen_pit[0][0] + screen_pit[0][1] - 1);
	if (drop_in_pit(P_dino_x, dino_y, 16, p_foothold,&dino_in_pit))
	{
		dino_in_pit = 1;
	}
	else if (dino_y < 0)
    {
		dino_in_pit = 0;
        dino_y = 0;
        foothold = 1;
    }
    if (dino_y > 0 || 0)
    {
        foothold = 0;
    }
	memset(screen_pit, -1, sizeof(screen_pit));
	//pos = pos + speed;
	//if(pos>ground_length) pos=0;
}

// 绘制云朵
void OLED_DrawCloud()
{
	static int pos = 128;
	static char height=0;
	char speed = 3;
	unsigned int i=0;
	int start_x = 0;
	int length = sizeof(CLOUD);
	unsigned char byte;

	//if (pos + length <= -speed) pos = 128;

	if (pos + length <= -speed)
	{
		pos = 128;
		height = rand()%3;
	}
	if(pos < 0)
	{
		start_x = -pos;
		OLED_SetPos(0, 1+height);
	}
	else
	{
		OLED_SetPos(pos, 1+height);
	}

	for (x = start_x; x < length + speed; x++)
	{
		if (pos + x > 127) break;
		if (x < length-1) byte = CLOUD[x];
		else byte = 0x0;
		oledWriteByte(byte,OLED_DATA);
	}
	pos = pos - speed;
}






